<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Temp Chat</title>
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

<style>
body{
  background:black;
  color:#00ff57;
  font-family:monospace;
}
.container{
  max-width:480px;
  margin:20px auto;
  border:1px solid #00ff57;
  padding:10px;
}
.top{
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.spinner{animation:spin 1s linear infinite;}
@keyframes spin{100%{transform:rotate(360deg)}}
.chat{
  height:300px;
  overflow-y:auto;
  border:1px solid #00ff57;
  padding:8px;
  margin:10px 0;
}
.bubble{
  max-width:70%;
  padding:6px;
  margin:6px 0;
  border-radius:8px;
}
.self{
  margin-left:auto;
  background:#003300;
  text-align:right;
}
.other{
  margin-right:auto;
  background:#111;
}
.controls{
  display:flex;
  gap:5px;
}
input,button{
  background:black;
  color:#00ff57;
  border:1px solid #00ff57;
  padding:6px;
}
#typing{font-size:12px;}
.hidden{display:none}
</style>
</head>

<body>
<div class="container">

<div class="top">
  <div id="serverStatus"><span class="spinner">ðŸ”„</span> Connecting</div>
  <div id="timer">00:00</div>
</div>

<hr>

<div>Your Code: <b id="myCode"></b></div>

<div class="controls">
  <input id="targetCode" placeholder="4 digit code">
  <button id="connectBtn">Connect</button>
  <button id="disconnectBtn" class="hidden">Disconnect</button>
</div>

<div id="typing"></div>

<div class="chat" id="chat"></div>

<div class="controls">
  <span onclick="file.click()">ðŸ“Ž</span>
  <input id="msg" placeholder="Message">
  <button id="send">Send</button>
</div>

<input type="file" id="file" hidden>

</div>

<script>
const socket = io("https://device-connector-backend.onrender.com");

const myCode = Math.floor(1000 + Math.random()*9000);
myCodeEl.textContent = myCode;

let sec=0,timer=null;

socket.on("connect",()=>{
  serverStatus.innerHTML="âœ… Server Connected";
  socket.emit("register-device",{code:myCode});
});

function startTimer(){
  timer=setInterval(()=>{
    sec++;
    timerEl.innerText=
      String(Math.floor(sec/60)).padStart(2,"0")+":"+
      String(sec%60).padStart(2,"0");
  },1000);
}

connectBtn.onclick=()=>{
  socket.emit("connect-to-code",{fromCode:myCode,targetCode:targetCode.value});
};

disconnectBtn.onclick=()=>{
  location.reload();
};

socket.on("connection-success",()=>{
  startTimer();
  disconnectBtn.classList.remove("hidden");
});

send.onclick=()=>{
  if(!msg.value)return;
  socket.emit("send-message",{text:msg.value});
  add(msg.value,"self");
  msg.value="";
};

socket.on("receive-message",(d)=>add(d.text,"other"));

msg.oninput=()=>socket.emit("typing",true);
socket.on("typing",s=>typing.innerText=s?"Typing...":"");

file.onchange=e=>{
  const f=e.target.files[0];
  if(!f)return;
  const r=new FileReader();
  r.onload=()=>{
    socket.emit("send-file",{name:f.name,data:r.result});
    add("ðŸ“Ž "+f.name,"self");
  };
  r.readAsDataURL(f);
};

socket.on("receive-file",d=>add("ðŸ“Ž "+d.name,"other"));

function add(text,type){
  const d=document.createElement("div");
  d.className="bubble "+type;
  d.innerText=text;
  chat.appendChild(d);
  chat.scrollTop=chat.scrollHeight;
}
</script>
</body>
</html>
